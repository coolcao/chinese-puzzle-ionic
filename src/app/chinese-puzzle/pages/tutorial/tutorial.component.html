<div
  [ngClass]="{ hidden: resourceLoading }"
  class="h-screen w-screen select-none overflow-hidden bg-wood-lighter transition-colors duration-300 dark:bg-dark-wood-lighter"
  (keydown)="onKeyDown($event)"
  tabindex="0"
>
  <!-- PCÂ§ßÂ±èÂ∑¶Âè≥Â∏ÉÂ±Ä -->
  <div
    class="hidden h-full w-full flex-col bg-wood-light/50 dark:bg-dark-wood-dark/20 lg:flex"
  >
    <!-- È°∂ÈÉ®header -->
    <app-game-header
      titleTranslationKey="tutorial.title"
      [showBackButton]="true"
      [customButtons]="[
        {
          icon: 'help',
          position: 'right',
          classes:
            'absolute right-0 rounded-full bg-wood-light p-2 text-wood-text shadow-md hover:bg-wood/30 dark:bg-dark-wood-lighter dark:text-wood-light',
          onClick: toggleInstructions.bind(this),
        },
      ]"
      (backClick)="goBack()"
    ></app-game-header>

    <!-- ‰∏ãÈù¢ÈÉ®ÂàÜÂ∑¶Âè≥Â∏ÉÂ±Ä -->
    <div class="mx-auto flex max-w-6xl flex-1">
      <!-- Â∑¶‰æßÊ£ãÁõò -->
      <div class="flex flex-1 items-center justify-center p-6">
        <div class="flex max-w-2xl items-center justify-center">
          <div class="relative">
            <canvas
              #gameCanvasPC
              (touchmove)="onTouchMove($event)"
              class="rounded-md border-4 border-b-0 border-solid border-wood-darker"
            ></canvas>
          </div>
        </div>
      </div>

      <!-- Âè≥‰æß‰ø°ÊÅØÂç°Áâá -->
      <div class="flex h-full w-full items-center justify-center">
        <div
          class="m-6 flex w-80 flex-col rounded-lg border-2 border-wood-border bg-wood-light shadow-lg dark:bg-dark-wood-lighter dark:text-wood"
          [style.height.px]="
            fabricGameService.boardHeight * fabricGameService.cellSize
          "
        >
          <div class="rounded-t-lg border-b border-wood-border p-6">
            <h2
              class="mb-4 text-xl font-bold text-wood-text dark:text-wood-lighter"
            >
              {{ "tutorial.gameControl" | translate }}
            </h2>

            <!-- ÂΩìÂâçÂÖ≥Âç°‰ø°ÊÅØ -->
            <div class="mb-6">
              <label
                class="mb-2 block text-sm font-medium text-wood-text dark:text-wood-lighter"
              >
                {{ "tutorial.currentLevel" | translate }}
              </label>
              <div
                class="w-full rounded-lg border border-wood-border bg-wood/50 px-4 py-2 text-wood-text shadow-inner dark:bg-wood-dark/50 dark:text-wood-lighter"
              >
                <div class="font-semibold">
                  {{
                    currentLevel.name || ("tutorial.unknownLevel" | translate)
                  }}
                </div>
                <div
                  class="mt-1 text-xs text-wood-text/70 dark:text-wood-lighter/70"
                >
                  {{ "common.difficulty" | translate }}Ôºö{{
                    currentLevel.difficulty
                      ? ("levels.difficulty." + currentLevel.difficulty
                        | translate)
                      : ("common.unknown" | translate)
                  }}
                </div>
              </div>
            </div>

            <!-- Ê∏∏ÊàèÁä∂ÊÄÅ -->
            <div class="space-y-4">
              <div class="flex items-center justify-between">
                <span class="text-wood-text dark:text-wood-lighter">{{
                  "tutorial.currentSteps" | translate
                }}</span>
                <div
                  class="rounded-lg bg-wood/50 px-4 py-2 text-wood-text dark:text-wood-lighter"
                >
                  {{ steps }}
                </div>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-wood-text dark:text-wood-lighter">{{
                  "tutorial.gameStatus" | translate
                }}</span>
                <div class="rounded-lg bg-wood/50 px-4 py-2">
                  @if (finished()) {
                    <span class="text-green-600 dark:text-green-300">{{
                      "tutorial.completed" | translate
                    }}</span>
                  } @else {
                    <span class="text-wood-text dark:text-wood-lighter">{{
                      "tutorial.inProgress" | translate
                    }}</span>
                  }
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="currentTutorialData" class="flex-1 p-6">
            <!-- PCÁ´ØÔºöÈîôËØØÊèêÁ§∫Êó∂ÂÆåÂÖ®ÊõøÊç¢Ê†áÈ¢òÂíåÂÜÖÂÆπÔºåÂê¶ÂàôÊòæÁ§∫Ê≠£Â∏∏ÊïôÁ®ã -->
            @if (showTutorialError) {
              <!-- ÈîôËØØÊèêÁ§∫Ê®°Âºè - ÊõøÊç¢Ê†áÈ¢òÂå∫Âüü -->
              <div class="mb-4 flex items-center justify-between">
                <div class="flex-1">
                  <div class="mb-2 flex items-center space-x-3">
                    <span class="text-lg">‚ö†Ô∏è</span>
                    <h4 class="text-lg font-bold text-red-600 dark:text-red-400">
                      Êìç‰ΩúÈîôËØØ
                    </h4>
                  </div>
                  <div class="flex items-center space-x-2">
                    <span class="text-sm font-medium text-wood-text/80 dark:text-wood-lighter/80">
                      {{ "tutorial.step" | translate }}
                      {{ currentTutorialStep + 1 }}/{{ tutorialSteps.length }}
                    </span>
                  </div>
                </div>
                <button
                  (click)="skipTutorial()"
                  appClickSound
                  class="rounded-lg bg-wood-dark px-3 py-1.5 text-xs font-medium text-wood-lighter transition-colors md:hover:bg-wood-darker dark:bg-dark-wood-darker dark:md:hover:bg-dark-wood"
                >
                  {{ "tutorial.skip" | translate }}
                </button>
              </div>

              <!-- ÈîôËØØÊèêÁ§∫ÂÜÖÂÆπ -->
              <div class="rounded-lg border border-red-500 bg-red-50 px-2 py-1.5 shadow-sm dark:border-red-400 dark:bg-red-900/80">
                <div class="flex items-center space-x-2">
                  <div class="flex-shrink-0">
                    <svg
                      class="h-4 w-4 text-red-500 dark:text-red-400"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.314 18.5c-.77.833.192 2.5 1.732 2.5z"
                      />
                    </svg>
                  </div>
                  <div class="flex-1">
                    <p class="text-xs font-medium text-red-800 dark:text-red-200">
                      {{ tutorialError }}
                    </p>
                  </div>
                  <button
                    (click)="hideTutorialError()"
                    class="flex-shrink-0 text-red-500 md:hover:text-red-700 dark:text-red-400 dark:md:hover:text-red-200"
                  >
                    <svg
                      class="h-3 w-3"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M6 18L18 6M6 6l12 12"
                      />
                    </svg>
                  </button>
                </div>
              </div>

              <!-- ÈîôËØØÁä∂ÊÄÅ‰∏ãÁöÑËøõÂ∫¶Êù° -->
              <div class="mb-4 mt-4 flex space-x-1.5">
                <div
                  *ngFor="let step of tutorialSteps; let i = index"
                  class="h-1.5 flex-1 rounded-full transition-colors"
                  [ngClass]="{
                    'bg-wood-darker dark:bg-wood-lighter':
                      i === currentTutorialStep,
                    'bg-wood-dark/60 dark:bg-wood/60': i < currentTutorialStep,
                    'bg-wood/30 dark:bg-dark-wood/30': i > currentTutorialStep,
                  }"
                ></div>
              </div>
            } @else {
              <!-- Ê≠£Â∏∏ÊïôÁ®ãÊ®°Âºè -->
              <div class="mb-4 flex items-center justify-between">
                <div class="flex-1">
                  <div class="mb-2 flex items-center space-x-3">
                    <span class="text-lg">
                      {{
                        currentTutorialData.type === "interact"
                          ? "üëÜ"
                          : currentTutorialData.type === "highlight"
                            ? "‚ú®"
                            : currentTutorialData.type === "move"
                              ? "üéØ"
                              : "üìñ"
                      }}
                    </span>
                    <h4
                      class="text-lg font-bold text-wood-text dark:text-wood-lighter"
                    >
                      {{ currentTutorialData.title }}
                    </h4>
                  </div>
                  <div class="flex items-center space-x-2">
                    <span
                      class="text-sm font-medium text-wood-text/80 dark:text-wood-lighter/80"
                    >
                      {{ "tutorial.step" | translate }}
                      {{ currentTutorialStep + 1 }}/{{ tutorialSteps.length }}
                    </span>
                  </div>
                </div>

                <button
                  (click)="skipTutorial()"
                  appClickSound
                  class="rounded-lg bg-wood-dark px-3 py-1.5 text-xs font-medium text-wood-lighter transition-colors md:hover:bg-wood-darker dark:bg-dark-wood-darker dark:md:hover:bg-dark-wood"
                >
                  {{ "tutorial.skip" | translate }}
                </button>
              </div>

              <p class="mb-4 text-sm text-wood-text/90 dark:text-wood-light/90">
                {{ currentTutorialData.description }}
              </p>

              <div class="mb-4 flex space-x-1.5">
                <div
                  *ngFor="let step of tutorialSteps; let i = index"
                  class="h-1.5 flex-1 rounded-full transition-colors"
                  [ngClass]="{
                    'bg-wood-darker dark:bg-wood-lighter':
                      i === currentTutorialStep,
                    'bg-wood-dark/60 dark:bg-wood/60': i < currentTutorialStep,
                    'bg-wood/30 dark:bg-dark-wood/30': i > currentTutorialStep,
                  }"
                ></div>
              </div>

              <div
                *ngIf="currentTutorialData.waitForUser"
                class="flex items-center justify-center space-x-2 rounded-lg bg-wood/30 py-2 dark:bg-dark-wood/30"
              >
                <div class="flex space-x-1.5">
                  <div
                    class="h-2 w-2 animate-bounce rounded-full bg-wood-darker dark:bg-wood-lighter"
                  ></div>
                  <div
                    class="h-2 w-2 animate-bounce rounded-full bg-wood-darker dark:bg-wood-lighter"
                    style="animation-delay: 0.1s"
                  ></div>
                  <div
                    class="h-2 w-2 animate-bounce rounded-full bg-wood-darker dark:bg-wood-lighter"
                    style="animation-delay: 0.2s"
                  ></div>
                </div>
                <span
                  class="text-sm font-medium text-wood-text dark:text-wood-lighter"
                  >{{ "tutorial.followInstructions" | translate }}</span
                >
              </div>

              <button
                *ngIf="!currentTutorialData.waitForUser"
                (click)="nextTutorialStep()"
                appClickSound
                class="w-full rounded-lg bg-wood-darker py-2.5 font-semibold text-wood-lighter transition-colors md:hover:bg-wood-dark dark:bg-wood-dark dark:text-wood-text dark:md:hover:bg-wood"
              >
                {{
                  currentTutorialStep === tutorialSteps.length - 1
                    ? ("tutorial.completeNext" | translate)
                    : ("tutorial.nextStep" | translate)
                }}
              </button>
            }
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ÁßªÂä®Á´Ø‰∏ä‰∏ãÂ∏ÉÂ±Ä -->
  <div class="tutorial-mobile-layout flex h-full flex-col lg:hidden">
    <app-game-header
      titleTranslationKey="tutorial.title"
      [showBackButton]="true"
      [customButtons]="[
        {
          icon: 'help',
          position: 'right',
          classes:
            'absolute right-2 rounded-full bg-wood-light p-2 text-wood-text shadow-md hover:bg-wood dark:bg-dark-wood-lighter dark:text-dark-wood-text dark:hover:bg-dark-wood',
          onClick: toggleInstructions.bind(this),
        },
      ]"
      (backClick)="goBack()"
    ></app-game-header>

    <div
      class="tutorial-content-mobile w-full bg-wood-light/70 dark:bg-dark-wood-darker/70"
    >
      <!-- ÊïôÁ®ãÊèêÁ§∫Ê†è - ÊõøÊç¢Áä∂ÊÄÅÊ†è‰ΩçÁΩÆ -->
      <div
        *ngIf="currentTutorialData"
        class="border-b-2 border-wood-border bg-wood-light px-4 py-1.5 shadow-sm backdrop-blur-sm transition-colors duration-300 dark:bg-dark-wood-dark"
      >
        <!-- ÁßªÂä®Á´ØÔºöÈîôËØØÊèêÁ§∫Êó∂ÂÆåÂÖ®ÊõøÊç¢Ê†áÈ¢òÂíåÂÜÖÂÆπÔºåÂê¶ÂàôÊòæÁ§∫Ê≠£Â∏∏ÊïôÁ®ã -->
        @if (showTutorialError) {
          <!-- ÈîôËØØÊèêÁ§∫Ê®°Âºè - ÊõøÊç¢Ê†áÈ¢òÂå∫Âüü -->
          <div class="mb-1 flex items-center justify-between">
            <div class="flex-1">
              <h4 class="text-sm font-bold text-red-600 dark:text-red-400">
                ‚ö†Ô∏è Êìç‰ΩúÈîôËØØ
              </h4>
            </div>
            <button
              (click)="skipTutorial()"
              appClickSound
              class="rounded-lg bg-wood-dark px-3 py-1 text-xs text-wood-lighter transition-colors md:hover:bg-wood-darker dark:bg-dark-wood-darker dark:text-wood-lighter dark:md:hover:bg-dark-wood"
            >
              {{ "tutorial.skip" | translate }}
            </button>
          </div>

          <!-- ÈîôËØØÊèêÁ§∫ÂÜÖÂÆπ -->
          <div class="rounded border border-red-500 bg-red-50 px-2 py-1 shadow-sm dark:border-red-400 dark:bg-red-900/80">
            <div class="flex items-center space-x-1.5">
              <div class="flex-shrink-0">
                <svg
                  class="h-3 w-3 text-red-500 dark:text-red-400"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.314 18.5c-.77.833.192 2.5 1.732 2.5z"
                  />
                </svg>
              </div>
              <div class="flex-1">
                <p class="text-xs font-normal text-red-800 dark:text-red-200">
                  {{ tutorialError }}
                </p>
              </div>
              <button
                (click)="hideTutorialError()"
                class="flex-shrink-0 text-red-500 md:hover:text-red-700 dark:text-red-400 dark:md:hover:text-red-200"
              >
                <svg
                  class="h-2.5 w-2.5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12"
                  />
                </svg>
              </button>
            </div>
          </div>

          <!-- ÈîôËØØÁä∂ÊÄÅ‰∏ãÁöÑËøõÂ∫¶Êù° -->
          <div class="mb-1 mt-2 flex space-x-1">
            <div
              *ngFor="let step of tutorialSteps; let i = index"
              class="h-1 flex-1 rounded-full transition-colors"
              [ngClass]="{
                'bg-wood-darker dark:bg-wood-lighter': i === currentTutorialStep,
                'bg-wood-dark dark:bg-wood': i < currentTutorialStep,
                'bg-gray-300 dark:bg-gray-600': i > currentTutorialStep,
              }"
            ></div>
          </div>
        } @else {
          <!-- Ê≠£Â∏∏ÊïôÁ®ãÊ®°Âºè -->
          <div class="mb-1 flex items-center justify-between">
            <!-- Ê≠•È™§ÂíåÊ†áÈ¢ò -->
            <div class="flex-1">
              <h4
                class="text-sm font-bold text-wood-text dark:text-wood-lighter"
              >
                {{ currentTutorialData.title }}
              </h4>
            </div>

            <!-- Ë∑≥ËøáÊåâÈíÆ -->
            <button
              (click)="skipTutorial()"
              appClickSound
              class="rounded-lg bg-wood-dark px-3 py-1 text-xs text-wood-lighter transition-colors md:hover:bg-wood-darker dark:bg-dark-wood-darker dark:text-wood-lighter dark:md:hover:bg-dark-wood"
            >
              {{ "tutorial.skip" | translate }}
            </button>
          </div>

          <!-- ÊèèËø∞ -->
          <p class="mb-1 text-xs text-wood-text dark:text-wood">
            {{ currentTutorialData.description }}
          </p>

          <!-- ËøõÂ∫¶Êù° -->
          <div class="mb-1 flex space-x-1">
            <div
              *ngFor="let step of tutorialSteps; let i = index"
              class="h-1 flex-1 rounded-full transition-colors"
              [ngClass]="{
                'bg-wood-darker dark:bg-wood-lighter': i === currentTutorialStep,
                'bg-wood-dark dark:bg-wood': i < currentTutorialStep,
                'bg-gray-300 dark:bg-gray-600': i > currentTutorialStep,
              }"
            ></div>
          </div>

          <!-- Êìç‰ΩúÊèêÁ§∫Êàñ‰∏ã‰∏ÄÊ≠•ÊåâÈíÆ -->
          <div
            *ngIf="currentTutorialData.waitForUser"
            class="flex items-center justify-center space-x-2"
          >
            <div class="flex space-x-1">
              <div
                class="h-2 w-2 animate-bounce rounded-full bg-wood-darker dark:bg-wood-lighter"
              ></div>
              <div
                class="h-2 w-2 animate-bounce rounded-full bg-wood-darker dark:bg-wood-lighter"
                style="animation-delay: 0.1s"
              ></div>
              <div
                class="h-2 w-2 animate-bounce rounded-full bg-wood-darker dark:bg-wood-lighter"
                style="animation-delay: 0.2s"
              ></div>
            </div>
            <span class="text-sm text-wood-text dark:text-wood">{{
              "tutorial.followInstructions" | translate
            }}</span>
          </div>

          <button
            *ngIf="!currentTutorialData.waitForUser"
            (click)="nextTutorialStep()"
            appClickSound
            class="w-full rounded-lg bg-wood-darker py-2 font-medium text-wood-lighter transition-colors md:hover:bg-wood dark:bg-wood-dark dark:text-wood-text dark:md:hover:bg-wood"
          >
            {{
              currentTutorialStep === tutorialSteps.length - 1
                ? ("tutorial.completeNext" | translate)
                : ("tutorial.nextStep" | translate)
            }}
          </button>
        }
      </div>
    </div>

    <div
      class="tutorial-board-container flex flex-1 flex-col items-center justify-center bg-wood-light/50 dark:bg-dark-wood-darker/50"
    >
      <div class="relative flex w-full justify-center">
        <div class="relative">
          <canvas
            #gameCanvasMobile
            (touchmove)="onTouchMove($event)"
            class="h-auto rounded-md border-4 border-b-0 border-solid border-wood-darker"
          ></canvas>
        </div>
      </div>
    </div>
  </div>

  <div>
    @if (showSuccess) {
      <app-scatter-flowers></app-scatter-flowers>
    }
    @if (showInstructions) {
      <div
        class="fixed inset-0 z-50 bg-black/30 backdrop-blur-sm"
        (click)="showInstructions = false"
      ></div>
    }

    <div
      *ngIf="showInstructions"
      class="fixed left-1/2 top-1/2 z-50 w-[90%] max-w-md -translate-x-1/2 -translate-y-1/2 rounded-2xl border-2 border-wood-border bg-wood-light/95 p-6 shadow-2xl backdrop-blur-sm transition-all dark:bg-dark-wood-lighter"
    >
      <div class="mb-4 flex items-center justify-between">
        <h3 class="text-2xl font-bold text-wood-text dark:text-wood-lighter">
          {{ "tutorial.instructions.title" | translate }}
        </h3>
        <button
          (click)="showInstructions = false"
          class="text-wood-text md:hover:bg-wood-dark dark:text-wood-lighter"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
      </div>

      <div class="space-y-4 text-wood-text dark:text-wood-light">
        <div class="flex items-start gap-3">
          <div
            class="flex h-6 w-6 shrink-0 items-center justify-center rounded-full bg-wood-light text-wood-text"
          >
            1
          </div>
          <p>
            {{ "tutorial.instructions.step1" | translate }}
          </p>
        </div>

        <div class="flex items-start gap-3">
          <div
            class="flex h-6 w-6 shrink-0 items-center justify-center rounded-full bg-wood-light text-wood-text"
          >
            2
          </div>
          <p>
            {{ "tutorial.instructions.step2" | translate }}
          </p>
        </div>

        <div class="flex items-start gap-3">
          <div
            class="flex h-6 w-6 shrink-0 items-center justify-center rounded-full bg-wood-light text-wood-text"
          >
            3
          </div>
          <p>
            {{ "tutorial.instructions.step3" | translate }}
          </p>
        </div>

        <div class="flex items-start gap-3">
          <div
            class="flex h-6 w-6 shrink-0 items-center justify-center rounded-full bg-wood-light text-wood-text"
          >
            4
          </div>
          <p>
            {{ "tutorial.instructions.step4" | translate }}
          </p>
        </div>
      </div>

      <button
        (click)="showInstructions = false"
        class="mt-6 w-full rounded-lg bg-wood-dark py-3 font-medium text-wood-text transition-colors md:hover:bg-wood/60 dark:bg-wood/30 dark:text-wood-light"
      >
        {{ "tutorial.instructions.startGame" | translate }}
      </button>
    </div>
  </div>
</div>

<div
  [ngClass]="{ hidden: !resourceLoading }"
  class="flex h-full min-h-screen w-full flex-col items-center justify-center bg-wood-lighter dark:bg-dark-wood-bg"
>
  <div class="text-2xl text-wood-text dark:text-wood-lighter">
    <div class="loader"></div>
  </div>
</div>
